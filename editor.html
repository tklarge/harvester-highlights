// === SPLIT combined highlights.ca.json into per-city files ===
// Runs in the Console on your live site. Make sure multiple downloads are allowed.

(async () => {
  const COMBINED_URL = '/highlights.ca.json?nocache=' + Date.now();
  const CODES = ['yvr','yyz','yul','yeg','yyc']; // add/remove codes as needed

  // Save helper
  const save = (name, obj) => {
    const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(a.href), 500);
  };

  // Fetch combined JSON
  let data;
  try {
    const res = await fetch(COMBINED_URL, { cache: 'no-store' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    data = await res.json();
  } catch (err) {
    console.error('Failed to fetch', COMBINED_URL, err);
    alert('Could not fetch /highlights.ca.json. Open your LIVE site (not GitHub) and try again.');
    return;
  }

  // Helpers to slice by city code across several shapes
  const U = s => (s || '').toString().trim().toUpperCase();
  const matches = (t, code) =>
    U(t?.route?.origin || t?.origin || t?.city || t?.code || t?.airport) === U(code);

  const sliceBy = (source, code) => {
    if (Array.isArray(source)) return source.filter(t => matches(t, code));
    if (Array.isArray(source?.tiles)) return source.tiles.filter(t => matches(t, code));
    if (Array.isArray(source?.items)) return source.items.filter(t => matches(t, code));
    if (source?.cities?.[U(code)]) {
      const c = source.cities[U(code)];
      return Array.isArray(c?.tiles) ? c.tiles : (Array.isArray(c) ? c : []);
    }
    if (source?.[U(code)]) {
      const c = source[U(code)];
      return Array.isArray(c?.tiles) ? c.tiles : (Array.isArray(c) ? c : []);
    }
    return [];
  };

  const results = [];
  for (const code of CODES) {
    const tiles = sliceBy(data, code);
    // keep basic meta if the combined file had it
    const out = Array.isArray(data)
      ? tiles
      : { ttl_hours: data.ttl_hours ?? 48,
          generated_at_iso: data.generated_at_iso ?? data.generated ?? null,
          tiles };

    const file = `highlights.${code}.json`;
    save(file, out);
    results.push({ city: code.toUpperCase(), tiles: tiles.length, file });
  }

  console.table(results);
  console.log('âœ… Downloads started. If prompted, click "Continue allowing automatic downloads".');
})();
