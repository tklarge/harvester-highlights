<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Harvester Highlights</title>
  <!-- Tiny inline favicon to silence 404s -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ctext y='50%25' x='50%25' text-anchor='middle' dominant-baseline='middle' font-size='48'%3E✈️%3C/text%3E%3C/svg%3E">

  <style>
    :root{
      --bg:#0b0e13; --card:#151a22; --muted:#91a0b6; --text:#eaf0ff; --accent:#9dd2ff;
      --ring:#2b364c; --pill:#1e2633;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
    a{color:var(--accent);text-decoration:none}
    header{padding:20px}
    h1{margin:0 0 6px}
    .meta{color:var(--muted);font-size:13px;margin:6px 0 14px}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:0 20px 6px}
    select,.btn{
      background:#0f151a;border:1px solid var(--ring);color:var(--text);
      padding:8px 10px;border-radius:10px;cursor:pointer
    }
    .btn:hover{filter:brightness(1.1)}
    .grid{
      display:grid;grid-template-columns:repeat(auto-fill, minmax(300px,1fr));
      gap:14px;padding:0 20px 30px;max-width:1200px;margin:0 auto
    }
    .card{background:var(--card);border:1px solid var(--ring);border-radius:18px;padding:14px 14px 12px;display:flex;flex-direction:column;gap:9px;min-height:170px}
    .title{font-size:18px;font-weight:620}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;background:var(--pill);border:1px solid var(--ring);
          border-radius:18px;padding:4px 8px;font-size:12px}
    .status{padding:10px 20px 0;color:var(--muted);font-size:13px}
    .empty{opacity:.7;padding:40px 20px;text-align:center}
    footer{padding:14px 20px 24px;color:var(--muted);font-size:12px}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <header>
    <h1>Harvester Highlights</h1>
    <div id="banner" class="meta">loading…</div>
  </header>

  <div class="toolbar">
    <label for="city" class="muted">Dataset:</label>
    <select id="city">
      <option value="ca">Canada (combined)</option>
      <option value="yvr">YVR — Vancouver</option>
      <option value="yyz">YYZ — Toronto</option>
      <option value="yul">YUL — Montréal</option>
      <option value="yeg">YEG — Edmonton</option>
      <option value="yyc">YYC — Calgary</option>
    </select>

    <a id="downloadBtn" class="btn" href="#" download>Download JSON</a>
    <a id="openEditor" class="btn" href="#">Open Editor</a>
    <span class="right muted" id="statusNote"></span>
  </div>

  <div id="grid" class="grid" aria-live="polite"></div>
  <div id="empty" class="empty" hidden>No tiles in this dataset.</div>

  <footer>
    Tips: Use the dropdown to switch datasets. “Open Editor” jumps to the same city’s editor.
  </footer>

  <script>
    // --- helpers
    const $ = sel => document.querySelector(sel);
    const fmtDate = s => {
      try{
        if(!s) return '—';
        const d = new Date(s);
        if (Number.isNaN(d)) return s;
        return d.toISOString().slice(0,10);
      }catch{ return s || '—'; }
    };

    // Read ?city from URL or default
    const params = new URLSearchParams(location.search);
    const initialCity = (params.get('city') || 'ca').toLowerCase();

    const citySelect = $('#city');
    citySelect.value = ['ca','yvr','yyz','yul','yeg','yyc'].includes(initialCity) ? initialCity : 'ca';

    async function load(){
      const city = citySelect.value;
      const file = city === 'ca' ? 'highlights.ca.json' : `highlights.${city}.json`;
      const url = `${location.origin}/${file}?nocache=${Date.now()}`;

      // Update action links
      $('#downloadBtn').href = url.replace(/\?nocache=.*/,'');
      $('#openEditor').href = `${location.origin}/editor.html?city=${city === 'ca' ? 'yvr' : city}`;

      // Fetch and render
      $('#banner').textContent = 'loading…';
      $('#statusNote').textContent = '';
      $('#grid').innerHTML = '';
      $('#empty').hidden = true;

      let data, ok = false, err = null;
      try{
        const res = await fetch(url, { cache:'no-store' });
        ok = res.ok;
        data = await res.json();
      }catch(e){ err = e; }

      if(!ok || !data){
        $('#banner').textContent = `Failed to load ${file}`;
        $('#statusNote').textContent = err ? String(err) : '';
        $('#empty').hidden = false;
        return;
      }

      const tiles = Array.isArray(data.tiles) ? data.tiles : [];
      const gen = data.generated_at_iso || '—';
      const ttl = data.ttl_hours ?? '—';
      $('#banner').textContent = `dataset: ${file} • generated: ${fmtDate(gen)} • ttl: ${ttl}h • tiles: ${tiles.length}`;

      if(!tiles.length){
        $('#empty').hidden = false;
        return;
      }

      const grid = $('#grid');
      for (const t of tiles){
        const div = document.createElement('div');
        div.className = 'card';
        const route = t.route || {};
        const origin = route.origin || '';
        const dest = route.destination || '';
        const from = t.date_range?.from;
        const to = t.date_range?.to;
        const tags = (t.tags || []).slice(0, 6);
        const price = t.price_display || 'TBD';
        const last = t.last_refreshed_iso ? fmtDate(t.last_refreshed_iso) : '—';

        div.innerHTML = `
          <div class="title">${t.title || `${origin} → ${dest}`}</div>
          <div class="muted">${origin} → ${dest}</div>
          <div class="row muted">Dates: <span class="pill">${fmtDate(from)}</span> → <span class="pill">${fmtDate(to)}</span></div>
          <div class="row"><strong>Price:</strong> <span class="pill">${price}</span></div>
          <div class="row muted">Last updated: <span class="pill">${last}</span></div>
          <div class="row">
            ${tags.map(x => `<span class="pill">${x}</span>`).join('')}
          </div>
        `;
        grid.appendChild(div);
      }

      // push current selection into URL (no reload)
      const u = new URL(location.href);
      u.searchParams.set('city', city);
      history.replaceState(null, '', u);
    }

    citySelect.addEventListener('change', load);
    // initial render
    load();
  </script>
</body>
</html>
